from init_db import init_db
init_db()

# âœ… ÙƒÙˆØ¯ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ (Ø§Ø­Ø°ÙÙ‡ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯)
import sqlite3
DB_PATH = "orders.db"
def print_tables():
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("SELECT name FROM sqlite_master WHERE type='table';")
    tables = c.fetchall()
    conn.close()
    print("ğŸ“¦ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:", [t[0] for t in tables])
print_tables()

# Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯Ø§Øª
from flask import Flask, request
from dispatcher import dispatch_message

app = Flask(__name__)

# ØªØ®Ø²ÙŠÙ† Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø¤Ù‚ØªÙ‹Ø§ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
user_states = {}
user_orders = {}

@app.route("/", methods=["GET"])
def index():
    return "ğŸš€ Qurain Delivery Bot is Live!"

@app.route("/webhook", methods=["POST"])
def webhook():
    data = request.json
    print("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©:", data)  # Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù‡ÙŠÙƒÙ„

    if not data:
        return "âŒ No data received", 400

    # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù‚ÙŠÙ… Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† data
    user_id = data.get("from")
    message = data.get("body")
    latitude = data.get("latitude")
    longitude = data.get("longitude")

    if not user_id or not message:
        return "âŒ Missing fields", 400

    # Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ (ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø© "Ù‚Ø¨ÙˆÙ„")
    driver_id = None
    if "Ù‚Ø¨ÙˆÙ„" in message:
        driver_id = user_id

    response = dispatch_message(
        user_id=user_id,
        message=message,
        user_states=user_states,
        user_orders=user_orders,
        driver_id=driver_id,
        latitude=latitude,
        longitude=longitude
    )

    return "âœ… OK", 200